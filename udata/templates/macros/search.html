{% macro panel_sorter() %}
{% if kwargs %}
{% if in_url('sort') %}
    {% if request.args.sort.startswith('-') %}
        {% set sort, order = request.args.sort[1:], 'desc' %}
    {% else %}
        {% set sort, order = request.args.sort, 'asc' %}
    {% endif %}
    {% set label, default_order = kwargs[sort] %}
{% endif %}
<div class="panel-heading panel-sorter" data-toggle="collapse" data-target="#collapse-sorter">
    {% if sort %}
        {% set btn_class = 'btn-default' if order == default_order else 'btn-warning' %}
        <a class="btn {{ btn_class }} btn-xs pull-right"
            href="{{ url_rewrite(sort=sort if order == 'desc' else '-'+sort)|url_del('page') }}"
            title="{{ _('Ascending') if order == 'asc' else _('Descending') }}">
            <span class="fa fa-sort-amount-{{order}}"></span>
        </a>
    {% endif %}
    <h3 class="panel-title">
        <span class="glyphicon glyphicon-sort-by-attributes-alt"></span>
        {{ _('Sort by') }}
    </h3>
</div>
<div class="btn-group btn-group-justified btn-sorter">
    <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            {{ label or _('Relevance') }}
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a href="{{ url_rewrite(page=1)|url_del('sort') }}">
                    {{ _('Relevance') }}
                </a>
            </li>
            {% for field, (label, order) in kwargs.items() %}
            <li>
                <a href="{{ url_rewrite(sort=field if order == 'asc' else '-'+field)|url_del('page') }}">
                    {{ label }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}
{% endmacro %}


{% macro filter_label(name, label, icon=None, labelize=None) %}
{% set values = request.args.getlist(name) or [] %}
{% for value in values %}
<span class="tag label label-info" title="{{ label }}">
    {% if icon %}
    <span class="{{ icon }}"></span>
    {% endif %}
    <span>{{ labelize(value) if labelize else value }}</span>
    <a href="{{ ''|url_del('page', **{name: value}) }}">
        <span class="close-icon glyphicon glyphicon-remove"></span>
    </a>
</span>
{% endfor %}
{% endmacro %}


{% macro facet_panel(result, name, label, icon=None) %}
{% set facet = result.get_facet(name) %}
{% if facet.visible %}
    <div class="panel-heading clickable"
        data-toggle="collapse" data-target="#collapse-{{name}}">
        <h3 class="panel-title">
            {% if in_url(name) %}
            <a href="{{ url_del(None, name, 'page') }}"
                class="btn btn-xs btn-link pull-right" title="{{ _('Clear filter') }}">
                <span class="glyphicon glyphicon-remove"></span>
            </a>
            {% endif %}
            <span class="{{icon or 'glyphicon glyphicon-filter'}}"></span>
            {{ label or name }}
        </h3>
    </div>
    {% if facet.type == 'terms' %}
        {{ term_facet(name, facet, result.query) }}
    {% elif facet.type == 'models' %}
        {{ model_facet(name, facet, result.query) }}
    {% elif facet.type == 'range' %}
        {{ range_facet(name, facet, result.query) }}
    {% elif facet.type == 'daterange' %}
        {{ daterange_facet(name, facet, result.query) }}
    {% elif facet.type == 'temporal-coverage' %}
        {{ temporal_coverage_facet(name, facet, result.query) }}
    {% endif %}
{% endif %}
{% endmacro %}


{% macro term_facet(name, facet, query, labels=None) %}
<div id="collapse-{{name}}" class="list-group collapse in">
{% for term, count in facet.terms %}
    <a href="{{ query.to_url(**{name: term}) }}"
        class="list-group-item">
        {{ query.adapter.facets[name].labelize(term) }}
        <span class="badge pull-right">{{ count }}</span>
    </a>
{% endfor %}
</div>
{% endmacro %}


{% macro model_facet(name, facet, query) %}
<div id="collapse-{{name}}" class="list-group collapse in">
    {% for obj, count in facet.models %}
        <a href="{{ query.to_url(**{name: obj.id|string}) }}"
            class="list-group-item">
            {{ obj }}
            <span class="badge pull-right">{{ count }}</span>
        </a>
    {% endfor %}
</div>
{% endmacro %}


{% macro range_facet(name, facet, query) %}
<div id="collapse-{{name}}" class="panel-body collapse in">
    <div class="row">
        <div class="col-xs-12 slider-container">
            <input type="text" class="range-picker"
                data-url-pattern="{{ query.to_url(**{name: '__r__', 'replace': True}) }}"
                data-slider-min="{{ facet.min }}"
                data-slider-max="{{ facet.max }}"
                data-slider-value="[{{ facet.min }},{{ facet.max }}]"/>
        </div>
    </div>
    <div class="row">
        <b class="col-xs-6">{{ facet.min }}</b>
        <b class="col-xs-6 text-right">{{ facet.max }}</b>
    </div>
</div>
{% endmacro %}


{% macro daterange_facet(name, facet, query) %}
<div id="collapse-{{name}}" class="panel-body collapse in">
    <div class="row">
        <div class="col-xs-12">
            <input type="hidden" class="date-range-picker"
                value="{{ facet.min.isoformat() }} - {{ facet.max.isoformat() }}" />
        </div>
    </div>
</div>
{% endmacro %}


{% macro temporal_coverage_facet(name, facet, query) %}
<div id="collapse-{{name}}" class="panel-body collapse in temporal-coverage"
    data-url-pattern="{{ query.to_url(**{name: '__r__', 'replace': True}) }}">
    <div class="row">
        <div class="col-xs-12">
            <div class="input-daterange input-group" id="datepicker">
                <input type="text" class="input-sm form-control" name="start"
                    value="{{ facet.min.isoformat() }}"
                    data-isodate="{{ facet.min.isoformat() }}"/>
                <span class="input-group-addon">{{ _('to') }}</span>
                <input type="text" class="input-sm form-control" name="end"
                    value="{{ facet.max.isoformat() }}"
                    data-isodate="{{ facet.max.isoformat() }}"/>
            </div>
        </div>
    </div>
    <div class="row hide">
        <div class="col-xs-12 text-center">
            <div class="facet-datepicker"
                date-date-format="yyyy-mm-dd"
                data-date-start-date="{{ facet.min.isoformat() }}"
                data-date-end-date="{{ facet.max.isoformat() }}"
            ></div>
        </div>
    </div>
    <div class="row hide">
        <div class="col-xs-12">
            <a class="btn btn-default btn-block btn-apply">
                <span class="{{ ficon('refresh') }}"></span>
                {{ _('Apply') }}
            </a>
        </div>
    </div>
</div>
{% endmacro %}


{% macro panel_header(result) %}
<div class="panel-heading">
    {% if result.total %}
        {{ _('Results %(start)s to %(end)s on %(total)s found',
            start=result.page_start,
            end=result.page_end,
            total=result.total,
        ) }}
    {% else %}
        {{ _('No result found') }}
    {% endif %}
</div>
{% endmacro %}
